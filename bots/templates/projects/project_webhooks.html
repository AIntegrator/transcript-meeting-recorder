{% extends 'projects/sidebar.html' %} {% load bot_filters %} {% block content %}
<!-- Create Modal -->
<div class="modal" id="createWebhookModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Webhook Subscription</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form
          hx-post="{% url 'projects:create-webhook' project.object_id %}"
          hx-target="#webhookSubscribeResult"
          hx-swap="innerHTML"
          hx-on::after-request="this.reset()"
        >
          {% csrf_token %}
          <div class="mb-3">
            <label for="url" class="form-label">Webhook URL</label>
            <input
              type="text"
              class="form-control"
              id="url"
              name="url"
              required
            />
          </div>
          <div class="mb-3">
            <label for="triggers" class="form-label">Triggers</label>
            <select
              class="form-select"
              id="triggers"
              name="triggers[]"
              multiple
              required
            >
              {% for option in webhook_options %}
              <option value="{{ option }}">
                {{ option|map_trigger_types }}
              </option>
              {% endfor %}
            </select>
          </div>
          <button id="submitBtn" type="submit" class="btn btn-primary">
            Create
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Result Modal (will be populated after webhook subscription) -->
<div class="modal" id="webhookSubscribeResultModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content" id="webhookSubscribeResult">
      <!-- Content will be replaced by HTMX -->
    </div>
  </div>
</div>

<!-- Existing Webhooks Table -->

<div class="container mt-4">
  <div class="table-responsive" id="webhooksTable">
    {% if webhooks %}
    <h2>Webhooks</h2>
    <!-- Create Button -->
    <button
      class="btn btn-primary mb-3 mt-3"
      data-bs-toggle="modal"
      data-bs-target="#createWebhookModal"
    >
      Create Webhook Subscription
    </button>

    <table class="table">
      <thead>
        <tr>
          <th>Webhook URL</th>
          <th>Subscribed Triggers</th>
          <th>Is Active</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for webhook in webhooks %}
        <tr>
          <td>{{ webhook.url }}</td>
          <td>{{ webhook.triggers|map_trigger_types|join:", " }}</td>
          <td>
            {% if webhook.is_active %}
            <input type="checkbox" checked disabled />
            {% else %}
            <input type="checkbox" disabled />
            {% endif %}
          </td>
          <td>
            {{ webhook.created_at|date:"M d, Y H:i" }}
          </td>
          <td>
            <button
              class="btn btn-danger btn-sm"
              data-bs-toggle="modal"
              data-bs-target="#deleteModal{{ webhook.object_id }}"
            >
              Delete
            </button>

            <!-- Delete Confirmation Modal -->
            <div
              class="modal"
              id="deleteModal{{ webhook.object_id }}"
              tabindex="-1"
            >
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                    ></button>
                  </div>
                  <div class="modal-body">
                    <p>
                      Are you sure you want to delete the webhook? This action
                      cannot be undone.
                    </p>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Cancel
                    </button>
                    <button
                      class="btn btn-danger"
                      hx-delete="{% url 'projects:delete-webhook' project.object_id webhook.object_id %}"
                      hx-swap="outerHTML"
                      hx-select="#webhooksTable"
                      hx-target="#webhooksTable"
                      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                      data-bs-dismiss="modal"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <h2>Webhooks</h2>
    <p class="text-center mt-4">No webhooks found</p>
    <p class="text-center">
      <button
        class="btn btn-primary mb-3"
        data-bs-toggle="modal"
        data-bs-target="#createWebhookModal"
      >
        Create new webhook
      </button>
    </p>
    {% endif %}
  </div>
</div>

{% endblock %}
