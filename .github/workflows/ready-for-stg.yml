name: PR Approval & Staging Ready

on:
  pull_request:
    branches:
      - main
    types: [opened, reopened, synchronize, labeled] # Run on PR creation/update, including label changes
  pull_request_review:
    types: [submitted] 

jobs:
  check-approvals-and-notify:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Determine PR Number
        id: extract_pr
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ github.event.review.pull_request_number }}" >> $GITHUB_OUTPUT
          fi

      - name: Check for required approvals
        # Only run this step if it's NOT a simple 'labeled' event (otherwise it can fail/run unnecessarily)
        if: ${{ github.event_name != 'pull_request' || github.event.action != 'labeled' }}
        id: check_approvals
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.extract_pr.outputs.pr_number }}
          REQUIRED_COUNT: 2
        run: |
          echo "Checking approvals for PR #$PR_NUMBER"

          # Use the GitHub CLI to get a list of unique 'APPROVED' reviews
          APPROVED_COUNT=$(gh pr view $PR_NUMBER --json reviews --jq '
            .reviews
            | map(select(.state == "APPROVED"))
            | unique_by(.author.login)
            | length
          ')

          echo "Found $APPROVED_COUNT approvals (Required: $REQUIRED_COUNT)"

          if [ "$APPROVED_COUNT" -ge "$REQUIRED_COUNT" ]; then
            echo "approved=true" >> $GITHUB_OUTPUT
            # Capture the head_ref for the notification
            echo "head_ref=$(gh pr view $PR_NUMBER --json headRefName -q .headRefName)" >> $GITHUB_OUTPUT
          else
            echo "approved=false" >> $GITHUB_OUTPUT
          fi

      - name: Add 'ready-for-stg' label
        # Only attempt to add the label if the approvals step was run AND it succeeded
        if: ${{ steps.check_approvals.outcome == 'success' && steps.check_approvals.outputs.approved == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.extract_pr.outputs.pr_number }}
        run: |
          echo "Adding 'ready-for-stg' label to PR #$PR_NUMBER"
          gh pr edit $PR_NUMBER --add-label "ready-for-stg" -f

      - name: Notify Google Chat (Ready for Staging)
        id: notify_chat # Automatic label and manual label attached
        if: |
          ${{ 
            (steps.check_approvals.outcome == 'success' && steps.check_approvals.outputs.approved == 'true') ||
            (github.event_name == 'pull_request' && github.event.action == 'labeled' && github.event.label.name == 'ready-for-stg')
          }}
        uses: SimonScholz/google-chat-action@main
        with:
          webhookUrl: "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}"
          title: "Ready for Staging Deployment"
          subtitle: "Branch: ${{ steps.check_approvals.outputs.head_ref || github.event.pull_request.head.ref }}"
